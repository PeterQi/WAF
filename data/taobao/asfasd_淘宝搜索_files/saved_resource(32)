/*! messenger 2015-01-08 */
KISSY.add("tbc/messenger/1.2.0/index",function(a,b,c,d,e,f){function g(a,b){return x.push([a,b])-1}function h(a){return x[a]="1.2.0"}function i(a,b,c){y?j(a,b,c):z.push([a,b,c])}function j(c,d,f){var g={type:c,content:d},h=f;a.isString(f)?(h=b.get("#"+f),f=h.contentWindow):v||w||f.contentWindow&&(f=f.contentWindow),n()?f.KISSY.TBC.Messenger.fire(c,d):v?setTimeout(function(){o.callSWF?o.callSWF("send",[g,m(h)]):o.send(g,m(h))},500):f.postMessage(e.stringify(g),"*")}function k(b,c){a.each(x,function(a){a[0]===b&&a[1](c)})}function l(c,d){var e,f="parentFlash="+A+"&childFlash=_MessengerChildFlash_"+a.now()+"&domain="+document.domain;a.isString(c)?(e=c,c={}):e=c.src,c.src=e+(e.indexOf("?")>-1?"&":"?")+f;var g=b.create("<iframe>",c);return g.setAttribute("width",1),g.setAttribute("height",1),b.get(d||"body").appendChild(g)}function m(a){var b=a.src;if(b){var c=b.match(/childFlash=([^&]+)/);if(c&&c[1])return c[1];throw"iframe has no flashName param"}var d=/parentFlash=([^&]+)/,c=u.match(d);if(c&&c[1])return c[1];throw"iframe has no topFlashName param"}function n(a){var a=a||document.domain,b=/^taobao\.(com|net)$/;return b.test(a)?!0:!1}if(a.TBC&&a.TBC.Messenger)return!1;var o,p=window,q=a.namespace("TBC.Messenger"),r=-1===location.host.indexOf("daily")&&-1===location.host.indexOf("net"),s="1.2.0",t=s?location.protocol+"//"+(r?"g.alicdn.com":"assets.daily.taobao.net/g")+"/tbc/messenger/"+s+"/flash-post-message.swf":"flash-post-message.swf",u=location.search,v="undefined"==typeof postMessage||!p.addEventListener,w=p.top!=p&&u.indexOf("domain")>-1,x=[],y=!v,z=[],A="_MessengerFlash_"+a.now();if(w){var B=/domain=([^&]+)/,C=location.search.match(B);C&&C[1]&&n(C[1])&&(document.domain=r?"taobao.com":"taobao.net")}if(n())y=!0;else if(v){window._Messenger_Flash_PostMessage=function(a,b){var c=b.type,d=b.msg;if("swfReady"===c){y=!0;for(var e;e=z.pop();)j.apply("1.2.0",e)}else"message"==c&&d&&k(d.type,d.content)};var C=u.match(/childFlash=([^&]+)/);C&&C[1]&&(A=C[1]);var D={src:t,attrs:{width:1,height:1,style:"position:absolute;top:0"},params:{flashVars:{jsentry:"_Messenger_Flash_PostMessage",swfid:"J_MessengerFlashPostMessage",name:A},allowscriptaccess:"always"}};parseFloat(a.version,10)>1.2?o=new f(D):a.Flash.add("#J_FlashPostMessageContainer",D,function(a){o=a.swf})}else p.addEventListener("message",function(b){var c=b.data,d=b.origin,f=/^https?\:\/\/(?:[\w\d]+\.)+(taobao|etao|alitrip)\.com(\/|$)/;if(f.test(d)&&c&&a.isString(c))try{var g=e.parse(c);k(g.type,g.content)}catch(h){}},!1);return a.mix(q,{register:g,unregister:h,send:i,createIframe:l,fire:k,flashName:A})},{requires:["dom","event","ua","json",parseFloat(KISSY.version,10)>1.2?"swf":"flash"]});KISSY.add("tbc/mpp-server/0.0.5/index",function(a,b,c){function d(a){this.config=a,this.reconCount=0,this.param="",this.pauseWs=!0,this.connect()}var e=-1===location.host.indexOf("daily")&&-1===location.href.indexOf(".net")&&-1===location.host.indexOf(":8080"),f=d.prototype;return a.mix(f,{connect:function(){window.WebSocket&&this.config.socket?this.pauseWs?this._createEventSource():this._createSocket():this._createLongPoll()},_createSocket:function(){var b=this,c=new WebSocket(this.config.socket+this.param+"&t="+a.now());c.onmessage=function(a){var d=b._onMessage(a.data);b._onStream(a.data),"9"==d&&(c.close(),b.pauseWs=!0,b.ws=null)},c.onclose=function(){b._onError(),b.ws=null},this.ws=c},_createEventSource:function(){var b=this,c=new XMLHttpRequest;c.onreadystatechange=function(){var a=c.responseText;if(3===c.readyState)a&&b._onMessage(a);else if(4===c.readyState)if(200===c.status&&a){var d=b._onMessage(a);("1"==d||"2"==d||"10"==d)&&b._onComplete()}else b._onError()},c.open("get",b.config.url+b.param+"&stream=true&t="+a.now(),!0),c.send()},_createLongPoll:function(){var c=this;b({url:this.config.url+this.param+"&t="+a.now(),type:"get",dataType:"text",success:function(a){var b=c._onMessage(a);("1"==b||"2"==b)&&c._onComplete()},error:this._onError})},_onMessage:function(a){this.reconCount=0;var b=this._parse(a),c=b.type,d=this.config;switch(this.param=b.key?"&key="+b.key:"",c){case"2":b.st&&d.message&&(d.message&&d.message.call(this,b.st),this._feedback(b.st));break;case"8":this._fetchHost();break;case"10":this.pauseWs=!1}return c},_onStream:function(a){var b=this.config;if(b.stream){var c=this._parse(a);b.stream.call(this,c)}},_onComplete:function(){this.connect()},_onError:function(){var a=this;++this.reconCount<3?setTimeout(function(){a.connect()},3e3+1e3*Math.ceil(40*Math.random())):location.href=location.href.replace(location.host,e?"mpp.taobao.com":"mpp.daily.taobao.net:8080");var b=this.config.error;b&&b.call(this)},_parse:function(b){if(!b)return!1;if(a.isString(b)){var d=b.split("}{"),e=b;d.length>1&&(e="{"+d[d.length-1]),b=c.parse(e)}return b},_fetchHost:function(){var b=this,c=a.unparam(b.param);a.jsonp("//allot-mpp."+(e?"taobao.com":"daily.taobao.net")+"/allot.do?appId="+this.config.appId,function(d){if(d&&"0"==d.code){var e=d.tn||"token",f=d.tn?d[d.tn]:d.token;c[e]=f,b.param=a.param(c);var g=location.search.replace("?",""),h={};g&&(h=a.unparam(g));for(var i in c)h[i]&&(h[i]=c[i]);var j=h.reconncount?1*h.reconncount:0;3>j&&(h.reconncount=j+1,setTimeout(function(){location.href=location.href.replace(location.host,d.host||location.host).replace(/\?.+$/,"?"+a.param(h))},5e3))}})},_feedback:function(b){var c=[];if(a.each(b,function(a){a.key&&c.push(a.key)}),c.length){var d=new Image;d.onload=function(){d.onload=null,d=null},d.src="//"+location.host+"/ack.do?key="+c.join(",")}}}),d},{requires:["ajax","json"]});/*! umpp 2015-01-08 */
KISSY.add("tbc/umpp/1.4.30/mods/storage",function(a){var b,c,d=window,e=document,f=location.host,g=d.localStorage;return g?c={getItem:function(a){return g.getItem(a)},setItem:function(b,c){var d=c;return(a.isObject(d)||a.isArray(d))&&(d=a.JSON.stringify(c)),g.setItem(b,d.toString())},removeItem:function(a){return g.removeItem(a)},clear:function(){return g.clear()}}:(b=e.createElement("input"),b.type="hidden",b.style.behavior="url(#default#userData)",e.body.appendChild(b),c={getItem:function(a){var c;try{b.load(f),c=b.getAttribute(a)}catch(d){}return c},setItem:function(c,d){var e=d;a.isObject(e)&&(e=a.JSON.stringify(d));try{b.load(f),b.setAttribute(c,e.toString()),b.save(f)}catch(g){}},removeItem:function(a){try{b.load(f),b.removeAttribute(a),b.save(f)}catch(c){}},clear:function(){try{b.load(f),b.expires=new Date((new Date).getTime()-1e4).toUTCString(),b.save(f)}catch(a){}}}),c},{requires:["core"]}),KISSY.add("tbc/umpp/1.4.30/mods/getNick",function(a){var b=a.namespace("TBC.umpp");return b.getNick=function(b){var c=a.Cookie.get("_nk_")||a.Cookie.get("lgc");return b&&c?encodeURIComponent(unescape(c.replace(/\\u/g,"%u"))):c}},{requires:["cookie"]}),KISSY.add("tbc/umpp/1.4.30/util/env/onLine",function(){return-1===location.host.indexOf("daily")}),KISSY.add("tbc/umpp/1.4.30/connect",function(a,b,c,d,e,f,g,h,i,j,k){function l(){this.userNick=i(),this.userMessageTag=this.userNick+"_",this.userActiveCollecterDelay=5e3}return a.mix(l.prototype,{start:function(){this.registerUmppEventFromParent(),this.sendMessageToParent("umppready","ok"),this.createConnection()},registerUmppEventFromParent:function(){var a=this;g.register("umpp-store-set",function(b){h.setItem(a.userMessageTag+b[0],b[1])}),g.register("umpp-store-get",function(b){var c=h.getItem(a.userMessageTag+b);a.sendMessageToParent("umpp-store-get-"+b,c)}),g.register("umpp-store-remove",function(b){h.removeItem(a.userMessageTag+b)}),g.register("umpp-monitor-event",function(b){if(a.monitoring){var c=h.getItem(a.userMessageTag+"-umpp-monitor-event");c||(c=""),c+=b+";",h.setItem(a.userMessageTag+"-umpp-monitor-event",c)}})},createConnection:function(){var a=this,b=location.search.match(/appId=(\d+)/),c=b&&b[1]?b[1]:1064,d="ctype=login&nkh="+this.userNick+location.search.replace("?","&");a.connection=new k({appId:c,url:"//"+location.host+"/buildconnection.do?"+d,socket:"ws://"+location.host+"/ws/b.do?"+d,message:function(b){return b&&b.length?(a.saveOfflineData.call(a,b),a.sendMessageToParent("umppdata",b),void 0):!1},stream:function(b){a.setUserActiveCollecter(b)}})},saveOfflineData:function(c){var d=this;a.each(c,function(c){var e=d.userMessageTag+c.t1,f=h.getItem(e),g=c.content;if(g){if(f)try{g=b.parse(g),f=b.parse(f),a.isObject(g)?g=a.mix(f,g,{deep:!0}):a.isArray(g)&&(g=f.concat(g),g.length>50&&g.splice(0,g.length-50))}catch(i){g=g}h.setItem(e,g)}})},sendMessageToParent:function(a,b){g.send(a,b,window.parent)},addUserActiveCollecter:function(){if(window.WebSocket){var a=this;a.monitoring=!0;var b=a.connection;a.userActiveCollecterTimer=setTimeout(function(){if(b&&b.ws){var c=h.getItem(a.userMessageTag+"-umpp-monitor-event");c&&(h.removeItem(a.userMessageTag+"-umpp-monitor-event"),b.ws.send(c))}a.userActiveCollecterTimer=setTimeout(arguments.callee,a.userActiveCollecterDelay)},a.userActiveCollecterDelay)}},removeUserActiveCollecter:function(){this.monitoring=!1,this.userActiveCollecterTimer&&(clearTimeout(this.userActiveCollecterTimer),this.userActiveCollecterTimer=null)},setUserActiveCollecter:function(a){var b=a.type;switch(b){case 20:this.addUserActiveCollecter();break;case 21:this.removeUserActiveCollecter();break;case 22:this.userActiveCollecterDelay=1e3*a.period;break;case 23:this.sendMessageToParent("umppdata",[{t1:"monitor-focustime",focustime:a.focustime}])}}}),new l},{requires:["json","ua","cookie","ajax","swf","tbc/messenger/1.2.0/","tbc/umpp/1.4.30/mods/storage","tbc/umpp/1.4.30/mods/getNick","tbc/umpp/1.4.30/util/env/onLine","tbc/mpp-server/0.0.5/"]});