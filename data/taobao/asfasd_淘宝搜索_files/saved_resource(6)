KISSY.add("tbc/search-suggest/6.1.3/index",["combobox","base","json","node","io","event","cookie","dom","ua"],function(e,t,a,n){var r,o,i,s,u,l,c,d,f,g=t("combobox"),p=t("base"),h=t("json"),m=t("node"),v=t("io"),b=t("event"),y=(t("cookie"),t("dom")),S=t("ua");r=function(e){function t(e){t.superclass.constructor.call(this,e||{})}var a=g;return t=a.extend({initializer:function(){var e=this;e.on("afterRenderData",function(){e.fire("beforeShow")})},sendRequest:function(e){var t=this,a=t.constructor.superclass.sendRequest;if(t.fire("beforeQueryChange",{query:e})===!1)return!1;t.queryTimer&&clearTimeout(t.queryTimer),t.laterTimer&&clearTimeout(t.laterTimer);var n=arguments;t.queryTimer=setTimeout(function(){t.queryTimer=null,t.laterTimer=setTimeout(function(){t.later=!1},500),a.apply(t,n)},t.later?200:50),t.later=!0},handleKeyDownInternal:function(e){var t=this,a=t.constructor.superclass.handleKeyDownInternal;return t.fire("beforeKeyDown",{event:e})===!1?!1:void a.apply(this,arguments)},handleKeyEventInternal:function(e){var t=this,a=t.constructor.superclass.handleKeyEventInternal;return t.fire("beforeKeyDown",{event:e})===!1?!1:void a.apply(this,arguments)},setValueInternal:function(e){var t=this,a=t.constructor.superclass.setValueInternal;return t.fire("beforeSetInputValue",{event:e})===!1?!1:void a.apply(this,arguments)},setValueFromAutocomplete:function(e){var t=this,a=t.constructor.superclass.setValueFromAutocomplete,n=t.constructor.superclass.setCurrentValue;return t.fire("beforeSetInputValue",{event:e})===!1?!1:void(a||n).apply(this,arguments)},renderItems:function(e,t,a){var n,r,o=this,i=o.get("sugConfig").resultFormat,s=o.resultArr||(o.resultArr=[]),u="",l=e;KISSY.each(t,function(e,o){if(!e||!e[0])return void t.splice(o,1);for(n=e[0];n.indexOf(l)<0;)l=l.substr(0,l.length-1);""===l?(u=n,n=""):0===n.indexOf(l)&&(u=l,n=n.replace(l,""));for(var c in s)if(r=s[c],r.textContent===e[0]&&r.unique)return;a=a.replace("{format}",i),s.push({textContent:e[0],content:KISSY.substitute(a,{query:u,text:n,index:o+1,count:e[1]}),list:!0})}),o.resultArr=s},alignInternal:function(e){var t=this,a=t.constructor.superclass.alignInternal;return t.fire("beforeShow",{event:e})===!1?!1:void a.apply(this,arguments)}},{ATTRS:{dataSourceCfg:{value:{xhrCfg:{url:"",dataType:"jsonp",scriptCharset:"utf-8",data:{code:"utf-8"}},allowEmpty:!0,paramName:"q",cache:!0}},mods:{value:{},setter:function(e){return e}}}}),t.RemoteDataSource=a.RemoteDataSource,t.LocalDataSource=a.LocalDataSource,e=t}(),o=function(e){return e={"new":{tmpl:'<div class="item-wrapper {prefixCls}menu-extras-xp" data-key="q={$queryUrl}&suggest=new_{$index}&tab=shopping&auction_tag[]=1154"><span class="{prefixCls}menu-xp-tag">新品</span><span class="{prefixCls}menu-xp-icon">新品</span><span class="{prefixCls}menu-xp">“{$query}”相关{new}新品</span></div>'},shop:{tmpl:'<div class="item-wrapper {prefixCls}menu-extras-dp" data-action="//shopsearch.taobao.com/search" data-key="q={$queryUrl}&suggest=shop_{$index}"><span class="{prefixCls}menu-dp">{$query} <b>相关店铺</b></span><span class="{prefixCls}menu-dp-icon">店铺</span></div>'},cat:{tmpl:'<div class="{prefixCls}menu-extras-cate" data-key="q={$3}&cat={$1}&suggest=cat_{$index}"><span class="{prefixCls}menu-key">{$2}</span><span class="{prefixCls}menu-cate">在<b>{$0}</b>分类下搜索</span></div>'},list:{tmpl:"<div data-index='{index}' class='item-wrapper' data-key='q={textContent}&suggest=0_{index}'><span class='item-text'>{query}<b>{text}</b></span><span class='item-count'>{format}</span></div>"},global:{tmpl:'<div class="{prefixCls}menu-extras-cate" data-key="q={$queryUrl}&promote=2097152&suggest=global_{$index}"><span class="{prefixCls}menu-key">{$query}</span><span class="{prefixCls}menu-cate">在全球购市场中搜索</span></div>'},history:{tmpl:'<div class="{prefixCls}menu-extras-history" {attr} data-key="q={historyItemQuery}&suggest={extraParam}_{index}" data-index="_his_{index}" data-value="{historyItemValue}"><span class="{prefixCls}menu-history-key">{historyItemValue}</span><a data-type="{extraParam}" class="{prefixCls}menu-history-delete">删除</a></div>'},scene:{tmpl:'<div class="{prefixCls}menu-extras-cate extras-scene" data-action="//fa.taobao.com/search" data-key="q={scene}&suggest=scene_{$index}"><span class="{prefixCls}menu-key">{scene}</span><b>装修宝典/选购秘籍</b></div>'},dapei_bottom:{tmpl:'<div class="item-wrapper {prefixCls}menu-extras-dp" data-source-stat="source_click=suggest_kfc&source_pv=suggest_kfc#!Content" data-action="//pose.taobao.com/search" data-key="q={dapei_bottom}"><span class="{prefixCls}menu-dp">{dapei_bottom}<b>全套搭配</b></span></div>'},dapei_top:{tmpl:'<div class="{prefixCls}menu-extras-cate" data-source-stat="source_click=suggest_jqc&source_pv=suggest_jqc#!Content" data-action="//pose.taobao.com/search" data-key="q={dapei_top}"><span class="{prefixCls}menu-key">{dapei_top}</span><span class="{prefixCls}menu-cate">在<b>搭配</b>下搜索</span></div>'},tmall:{tmpl:'<div class="{prefixCls}menu-extras-cate extras-mall" data-key="q={tmall}&suggest=tmall_{$index}&tab=mall"><span class="{prefixCls}menu-key">{tmall}</span><b>天猫相关</b></div>'},c2c_activity:{tmpl:'<div class="{prefixCls}menu-extras-cate extras-active" data-key="q={c2c_activity_query} {c2c_activity_tag}&suggest=active_{$index}"><span class="{prefixCls}menu-key">{c2c_activity_query}</span><span class="{prefixCls}menu-cate">在 <b>{c2c_activity_tag}</b> 中搜索</span></div>'},channelEntry:{tmpl:'<div class="{prefixCls}menu-channel-entry"><a href="{channelEntry_url}" class="channel-bg" style="background-image:url({channelEntry_img});background-color:{channelEntry_bgColor}"><span class="channel-prefix"></span><span>{channelEntry_title}</span></a></div>'},showExtra:!1}}(),i=function(e){function t(e){return a?a:(t.superclass.constructor.call(this,e||{}),void(a=this))}var a,n=p;return KISSY.extend(t,n,{pluginInitializer:function(e){var t=this;t.set("caller",e)},getCookie:function(e){var t=window;if(t.userCookie&&!KISSY.isUndefined(t.userCookie[e]))return t.userCookie[e];if(t.SRP_COOKIES||(t.SRP_COOKIES={})&&KISSY.isUndefined(SRP_COOKIES[e])){var a=document.cookie.match("(?:^|;)\\s*"+e+"=([^;]*)");a&&a[1]?SRP_COOKIES[e]=decodeURIComponent(a[1]):SRP_COOKIES[e]=""}return SRP_COOKIES[e]},fireEvent:function(e,t){var a=document;if(a.createEvent){var n=a.createEvent("MouseEvents");n.initEvent(t,!0,!1),e.dispatchEvent(n)}else a.createEventObject&&e.fireEvent("on"+t)}},{ATTRS:{pluginId:{value:"utils"}}}),e=t}(),s=function(e){function t(e){return a||(t.superclass.constructor.call(this,e||{}),a=this,a.initialize()),a}var a,n=p,r=h;return t.ATTRS={src:{value:location.protocol+"//g.alicdn.com/kg/search-suggest/6.0.10/storage.swf"},bridge:{value:null},hasInit:{value:!1}},KISSY.extend(t,n,{initialize:function(e){e=e||{};var t=this;try{t._addFlash(e.appendTo),t.hasInit=!0}catch(a){KISSY.log(a.message)}},_saveToArr:function(e,t){var a=this.lazyArr||[];a.push({func:e,args:t}),this.lazyArr=a},_addFlash:function(e){var t,a=this,n=document,r=n.createElement("div"),o=a.get("src"),i="";window.__StorageIsReady=function(){a.isLoaded=!0;var e=a.lazyArr;KISSY.each(e,function(e){e.func.apply(a,e.args)})},r.id="storagetool",r.style.height=0,r.style.overflow="hidden",i+='<object id="J_StorageObj" name="J_StorageObj" ',i+='classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000" width="1" height="1" ',i+='codebase="'+location.protocol+'//fpdownload.macromedia.com/pub/shockwave/cabs/flash/swflash.cab">',i+='<param name="movie" value="'+o+'" />',i+='<param name="allowScriptAccess" value="always" />',i+='<embed name="J_StorageEmbed" src="'+o+'" width="1" height="1" ',i+='allowScriptAccess="always" type="application/x-shockwave-flash" ',i+='pluginspage="'+location.protocol+'//www.adobe.com/go/getflashplayer">',i+="</embed></object>",e=e||n.body,e.appendChild(r),r.innerHTML=i,-1!==navigator.appVersion.indexOf("MSIE")?(r.style.zoom=1,r.style.filter="alpha(opacity=10)",t=window.J_StorageObj):(r.style.opacity=.1,t=n.J_StorageEmbed),a.set("bridge",t)},save:function(e,t,a){var n=this,o=n.get("bridge");if(!n.isLoaded)return void n._saveToArr(arguments.callee,arguments);try{return o.save(e,t),o.read(e)?r.parse(o.read(e)).length:(a&&a.onSuccess(t),0)}catch(i){a&&a.onFailure&&a.onFailure(i)}},read:function(e,t,a){var n,r=this,o=r.get("bridge");if(a=a||0,!r.isLoaded)return void r._saveToArr(arguments.callee,arguments);try{if(o.read)n=o.read(e),t&&t.onSuccess(n);else{if(200===a)return void(t&&t.onFailure&&t.onFailure());setTimeout(function(){r.read(e,t,a+1)},500)}return n}catch(i){t&&t.onFailure&&t.onFailure(i)}}}),e=t}(),u=function(e){var t=p,a=m,n=v,r=document.inputEncoding||document.characterSet||document.charset||"none";return r=r.toLowerCase(),e=t.extend({initializer:function(){var e=this.get("node");if(!e)throw new Error("Placeholder config.node 参数为空!");this.el=a.all(e),this.el&&(this.el.addClass("search-combobox-placeholcer"),this.render())},render:function(){var e=this;n({url:e.get("api"),dataType:"jsonp",success:function(t){var a=t.result;a&&a.show&&a.search&&e.generatorLabel(a)},error:function(){}})},generatorLabel:function(e){var t=this,a="<span>"+e.search+"</span>"+e.show,n='<label for="q" data-searchtype-item="'+a+'" >'+a+"</label>";t.el.html(n);var r=t.el.one("label");t.set("label",r),t.fire("placeholder:complete")}},{ATTRS:{api:{value:"//suggest.taobao.com/sug?area=shade_recommand&code="+r},node:{value:null},label:{value:null}}})}(),l=function(e){function t(e){t.superclass.constructor.call(this,e||{})}var a=p,n=i;return KISSY.extend(t,a,{getBucket:function(){var e=this,t=e.getCookieT(),a=e.getTestBucket()||e.retBucket(t,20,-4,4)-0;return a},getTestBucket:function(){var e=location.search,t=e.match(/alg_bts=(\d+)/);return t&&t[1]?t[1]-0:void 0},getCookieT:function(){var e=new n,t=e.getCookie("t");return t},retBucket:function(e,t,a,n){return e?this.countBucket(e,t,a,n):"0"},countBucket:function(e,t,a,n){var r=e.substr(a,n),o=parseInt(r,16),i=o%t+1;return i+""}},{ATTRS:{pluginId:{value:"bts"}}}),e=t}(),c=function(e){function t(e){t.superclass.constructor.call(this,e||{}),this.initialize()}var a=p,n=h,r=s,o="localQuery";return KISSY.extend(t,a,{initialize:function(){var e=this,t=e.get("name"),a=e.get("tab"),n=e.get("user");"item"===a&&(a="baobei"),e.storageKey=o+t+a+n,e._getStorage()},checkFlash:function(e){this.storage.read(e)},_setKey:function(e){var t=this,a=e.name||t.get("name"),n=e.tab||t.get("tab"),r=e.user||t.get("user");"item"===n&&(n="baobei"),t.storageKey=o+a+n+r,t.set("tab",n),t.set("name",a),t.set("user",r),this.datalist=null},_save:function(e,t){if(!e.match(/<>'"/)&&!t.match(/<>'"/)){var a=this._getDatalist(),n=encodeURIComponent(e),r={key:n,value:encodeURIComponent(t),time:KISSY.now()};this._deleteItemByValue(a,n),a.unshift(r)}},_deleteItemByValue:function(e,t){for(var a,n=null,r=0;r<e.length;r++)a=e[r].key,a===t&&(n=e.splice(r,1),r--)},_query:function(e){var t,a,n=this._getDatalist(),r=[];return e?(e=encodeURIComponent(e),KISSY.each(n,function(n){t=n.key,a=n.value,(0===t.indexOf(e)||0===a.indexOf(e))&&r.push(n)}),this._distinctByValue(r)):this._distinctByValue(n)},_distinctByValue:function(e){for(var t,a=[],n=0,r=e.length;r>n;n++)t=e[n],t.value.match(/%3C|%3E|[<>'"]/g)||this._hasItemOfValue(a,t.value)||a.push(t);return a},_hasItemOfValue:function(e,t){for(var a=!1,n=e.length-1;n>=0;n--)e[n].value===t&&(a=!0);return a},_cleanBefore:function(e){for(var t,a=this._getDatalist(),n=0,r=a.length-1;r>=0;r--)if(t=a[r],t.time>e){n=r+1;break}a.length=n},_getDatalist:function(){return this.datalist||(this.datalist=this.storage.read()||[]),this.datalist},_getStorage:function(){var e=this.get("storageType");switch(e){case"flashStorage":this.storage=this._initFlashStorage();break;default:this.storage=!1}},_initFlashStorage:function(){var e=this;return{save:function(){return(new r).save(e.storageKey,n.stringify(e.datalist))},read:function(t){var a=(new r).read(e.storageKey,t);if(a){var o=n.parse(a);return o}return void 0}}},destructor:function(){this.datalist=null,o=null},save:function(e,t){if(""!==t){var a,n=this.storage.read();n&&(a=n.length);var r=this._save(e,t),o=this.storage.save();return a>300&&(this.datalist=this.datalist.slice(0,a-10),KISSY.log("add_before\n"+o+"\n"+a),o=this.storage.save(),KISSY.log("add_after\n"+o+"\n"+a)),r}},query:function(e){return this._query(e)},deleteItem:function(e){var t=this._getDatalist(),a=t.length;this._deleteItemByValue(t,encodeURIComponent(e));var n=this.storage.save();a>300&&(this.datalist=this.datalist.slice(0,a-10),n=this.storage.save(),KISSY.log("delete\n"+n+"\n"+a))},clearByDay:function(e){var t=KISSY.now()-24*e*3600*1e3;this._cleanBefore(t),this.storage.save()},hasHistory:function(){return this._getDatalist().length>0?!0:!1}},{ATTRS:{name:{value:"default",setter:function(e){return e}},user:{value:"",setter:function(e){return KISSY.fromUnicode(e)}},maxLength:{value:500},storageType:{value:"flashStorage",setter:function(e){return e},getter:function(e){return e}}}}),e=t}(),d=function(e){function t(e){t.superclass.constructor.call(this,e||{})}var a=p,n=b,r=c;return KISSY.extend(t,a,{pluginInitializer:function(e){var t=this,a=t.get("stat");t.set("caller",e),e.on("beforeSubmit",function(e){var a=e.isInitSearch;t.setStat(a)}),a&&(t.sendTongji(),t.bindSearchTrace())},bindSearchTrace:function(){var e=this;n.delegate("body","click","a",e.initSearchTrace,e)},initSearchTrace:function(e){var t=this,a=e.currentTarget,n=a.getAttribute("trace"),r=a.getAttribute("href");if(n)switch(n){case"relatedSearch":t.saveQuery();break;case"auction":var o=t.stat;o&&-1===r.indexOf("initiative_new")&&a.setAttribute("href",r+"&initiative_new=1")}},sendTongji:function(){var e,t=this,a=t.getStatInst();a.checkFlash({onSuccess:function(){e=a.query("stat")[0],e&&e.value&&(t.stat=e.value,t.send("f_stats_show="+e.value,!0))}})},setStat:function(e,t){var a=this,n=a.get("caller"),r=n.query,o=a.saveQuery(r,e);o&&a.send("lf_aclog=null-null-null-null-0&stats_click="+o,t)},getStatInst:function(){var e=this,t=e.get("caller"),a=t.get("sugConfig"),n=a.tab||"",o=new r({name:"stat",tab:n});return o},saveQuery:function(e,t){var a,n,r=this.getStatInst();return t&&e?(a=encodeURIComponent(e),n="initiative_new:1;q:"+a,r.save("stat",n)):r.deleteItem("stat"),n},send:function(e,t){var a,n,r=this.get("logTypes");t?(r=this.get("tongjiKey"),a=r.logkey,n=r.chksum):(r=this.get("pvKey"),a=r.logkey,n=r.chksum),window.goldlog?goldlog.record(a,"",e,n):(window.goldlog_queue||(window.goldlog_queue=[])).push({action:"goldlog.record",arguments:[a,"",e,n]})},renderPlugin:function(){}},{ATTRS:{pluginId:{value:"stat"},tongjiKey:{value:{logkey:"/tongji",chksum:"H51884970"}},pvKey:{value:{logkey:"/search",chksum:"H51884969"}}}}),e=t}(),f=function(e){function t(e){for(var t="",a=0;a<e.length;++a){var n=e.charCodeAt(a).toString(16).toUpperCase();t+="\\u"+"0000".substr(n.length)+n}return t}var a=m,n=p,s=y,c=r,f=o,g=l,h=i,v=d,b=S,_=null,x=u,C=n.extend({initializer:function(){var e=this,t=e.get("placeholder");if(t.api&&(t.api="//suggest.taobao.com/sug?area=shade_recommand&code=utf-8"),e.hongbaoConfig=e.get("hongbao")||{},e.hongbaoConfig.open&&KISSY.Config.packages&&KISSY.Config.packages.hbhub&&(!b.ie||b.ie>=8)){var a=e.hongbaoConfig.query||"";KISSY.use("hbhub/index",function(t,n){_=n,e.hongbaoConfig.init&&setTimeout(function(){_.init(a)},150)})}t.show&&e._initPlaceholder(t),e._initCombo(),e.bindUtil()},bindUtil:function(){var e=this;e.Utils=new h,e.Stat=new v(e.get("statConfig"))},_setComboCache:function(e){var t=this,a=t.get("tab");t.configArr=t.configArr||[],t.configArr[a]={data:e}},_checkHasTab:function(){var e=this,t=e.getPlugin("tab");t||(e.tabNode=e.get("form"))},_initPlaceholder:function(e){var t=this;t.placeholder=new x(e),t.placeholder.on("placeholder:complete",function(){var e=t.placeholder.get("label");t.set("label",e),e.on("click",function(){t.comboBox.sendRequest("")})})},_initComboEvent:function(){var e=this,t=e.comboBox,a=t.get("input");a.on("mousedown",function(n){if(e.fire("beforeFocus")!==!1){var r=KISSY.trim(a.val()),o=e.get("sugConfig"),i=!0;i&&(o.autoCollapsed||""===r)&&t.sendRequest(r)}n.stopPropagation()}),a.on("focus",function(){e.fire("beforeFocus")}),a.on("blur",function(){return e.fire("beforeBlur")===!1?!1:void 0});var n=e.get("sugConfig").itemClick,r=!0;if(n&&KISSY.isFunction(n)){r=!1;var o=n.apply(this,arguments);o!==!1&&(r=!0)}r&&t.on("click",e.comboClick,e),t.on("afterCollapsedChange",e._addExtraEvent,e),t.on("afterCollapsedChange",function(t){e.fire("afterCollapsedChange",t)}),t.on("beforeQueryChange",function(t){e.fire("beforeQueryChange",t)}),t.on("beforeSetInputValue",function(){var t;t=e.placeholder?e.placeholder.get("label"):e.get("label"),t&&s.hide(t)}),e._formSubmitEvent(),e.query=a.val();var i=e.get("label");i&&i.on("click",function(){t.sendRequest(a.val())})},_formSubmitEvent:function(){var e,t=this,a=t.comboBox,n=a.get("input"),r=n.parent("form"),o=a.get("input");r.on("submit",function(a){if(t.fire("beforeSubmit",{el:r,isInitSearch:!0})!==!1){var n=KISSY.trim(o.val());t.hongbaoConfig.open&&_&&""!==n?_.intercept(n,function(){t.serializeToForm(r,e)},function(){o[0].blur(),a.halt()}):(e=r.attr("action"),""===n&&t._emptyJump(r)===!1&&a.preventDefault(),t.serializeToForm(r,e))}else a.halt()})},serializeToForm:function(e,t){var a,n,r,o="",i="";if(t&&e){if(-1===t.indexOf("?"))return;if(o=t.split("?")[1]){a=o.split("&");for(var s in a)n=a[s].split("="),r=n[0],r&&!e[0][r]&&(i+='<input type="hidden" name="'+n[0]+'" value="'+n[1]+'"/>');e.append(i)}}},_defaultPageJump:function(e){var t,a=this,n=a.tabNode;if(!n)return!1;if(t=e.attr("data-defaultpage")||n.attr("data-defaultpage")){if(!/(http(s:|:))?\/\//.test(t))return!1;e.attr("action",t)}},_emptyJump:function(e){var t,a=this,n=e.one("label");return n?(t=n.one("span"),t&&""!==t.text()?(n.hide(),void a._holderJump(e,t.text())):a._defaultPageJump(e)):a._defaultPageJump(e)},_holderJump:function(e,t){var a=e[0].q;a&&(a.value=t),e.append('<input type="hidden" name="style" value="grid" />'),e.append('<input type="hidden" name="hintq" value="1" />')},_sendSnapshot:function(e){var a,n=this,r=[],o=-1,i=0,s=n.get("statConfig");if(s.unicode)for(e.selected=t(e.selected),i=0;i<e.children.length;i++)a=e.children[i],a.value=t(a.value),e.selected===a.value?o=i:r.push(a.value+"/"+a.index);else for(i=0;i<e.children.length;i++)a=e.children[i],e.selected===a.value?o=i:r.push(a.value+"/"+a.index);var u="f_stats_show=xialalist:";u+=r.join(","),u=u+";query:"+e.query,u=u+";selected:"+e.selected+"/"+o,u=u+";time:"+KISSY.now(),u=u+";nick:"+n.getNick(),n.Stat.send(u,!0)},comboClick:function(e){var t,n=this,r=e.target.get?e.target.get("el"):a.one(e.currentTarget),o=n.comboBox,i=r.one(".item-text, .search-menu-key, .search-menu-history-key"),s=!1,u=n.get("form"),l=n.get("sugConfig").isSendByForm;if(i){t=i.text();var c=n.historyArr;if(c)for(var d=0,f=c.length-1;f>=d;d++)if(t===c[d]){s=!0;break}}for(var g=o.get("menu"),p=g.get("children"),h=[],m=0;m<p.length;m++){var v=p[m],b=v.get("value");b&&h.push({index:m,value:b[0]})}var y={query:n.query||"",children:h,selected:t||""};if(n._sendSnapshot(y),n.fire("beforeSubmit",{el:r,isInitSearch:!1,isNotSave:s})!==!1){var S=n.getRedirect(r);if(n.hongbaoConfig.open&&_)return _.intercept(t,function(){n.redirect(S)},function(){qNode[0].blur()}),!1;l?(n.serializeToForm(u,S),u[0].submit()):n.redirect(S)}},getRedirect:function(e){var t=this,a=t.query,n=t.query,r=s.children(e),o=s.attr(r,"data-key")||"q="+a,i=t.get("form")[0],u=s.attr(i,"action"),l=s.attr(r,"data-action")||t.get("action")||u,c=s.attr(r,"data-source-stat")||"source=suggest",d="&_input_charset=utf-8&wq="+encodeURIComponent(n)+"&suggest_query="+encodeURIComponent(a)+"&"+c,f=t._getInputsVal(i);l+=l.indexOf("?")>-1?"&":"?";var g=KISSY.unparam(o),p="";if(KISSY.isObject(g)){var h=[];for(var m in g)Object.prototype.hasOwnProperty.call(g,m)&&h.push(m+"="+encodeURIComponent(g[m]));p=h.join("&")}var v=l+f+"&"+(p||o)+d;return v},redirect:function(e){var t=this,a=t.get("sugConfig").isEncode;a?e=t.urlEncode(e):(e=e.replace(/(#)[^!]/g,function(e,t){return e.replace(t,"%23")}),e=e.replace(/#!/g,"#"));var n=document.createElement("a");n.setAttribute("href",e),n.setAttribute("target","_self"),n.style.display="none",document.body.appendChild(n),n.click()},urlEncode:function(e){var t=/[\u4e00-\u9fa5\uf900-\ufa2d+#\s]+/g.exec(e);if(t)try{e=e.replace("？","?"),e=e.replace(/[\u4e00-\u9fa5\uf900-\ufa2d+#]+/g,function(e){return encodeURIComponent(e)}),e=e.replace(/\s/g,function(){return"+"}),e+="&ie=utf-8"}catch(a){KISSY.log("url编码出错!")}return e},_getInputsVal:function(e){for(var t,a,n=this,r=n.get("sugConfig"),o=r.excludeParam,i=[],u=s.query("input",e),l=u.length-1;l>=0;l--)t=u[l],a=t.name,a&&!KISSY.inArray(a,o)&&i.push(a+"="+encodeURIComponent(t.value));return i.length<1?"":"&"+i.join("&")},_getDefComboCfg:function(){return{focused:!1,hasTrigger:!1,matchElWidth:!0,srcNode:".allWidth",highlightMatchItem:!1,menu:{align:{overflow:{adjustY:0}}},cache:!0}},_prepareHtml:function(e){var t=this,n=s.get(e.node),r=n.innerHTML,o=e.prefixCls,i=s.get(e.placeholderEl),u=i?i.outerHTML:"",l='<div class="{cls}combobox"><div class="{cls}combobox-input-wrap"></div></div>',c=l.replace(/{cls}/g,o).replace(/{label}/g,u).replace(/{input}/g,r),d=s.create(c),f={"aria-haspopup":"true","aria-combobox":"list",role:"combobox",autocomplete:"off","x-webkit-grammar":"builtin:translate"};return s.addClass(n,o+"combobox-input"),s.attr(n,"aria-label")||(t._isOpen("history")?f["aria-label"]="请输入搜索文字或从搜索历史中选择":f["aria-label"]="请输入搜索文字"),s.attr(n,f),s.wrap(n,d),this.get("sugConfig").focused&&s.get(n).focus(),a.one("."+o+"combobox")},_isOpen:function(e){var t=this,a=t.get("mods"),n=a.sort;return KISSY.inArray(e,n)},_getRenderMods:function(){var e=this,t=KISSY.merge(f,e.get("mods"));e.set("mods",t)},_getDataSourceCfg:function(){var e=this,t=e.get("sugConfig"),a=e.get("dataSourceCfg"),n=t.sourceUrl;return location.href.indexOf("debug=test")>-1&&(n=n.replace("suggest.taobao.com/sug?","suggest.proxy.taobao.org/sug?")),-1===n.indexOf("bucketid")&&(n+=-1===n.indexOf("?")?"?bucketid="+e._getBucketId():"&bucketid="+e._getBucketId()),a.xhrCfg.url=n,a.parse=KISSY.bind(e.parse,e),a},_getBucketId:function(){return(new g).getBucket()},_getComboCfg:function(e){var t=this,n=t.get("sugConfig"),r=t._getDefComboCfg(),o=n.prefixCls,i=a.one("."+o+"-combobox");return i||(i=t._prepareHtml(n)),r.srcNode=i,r.dataSource=e,r.format=KISSY.bind(t.format,t),r.prefixCls=n.prefixCls,n.placeholderEl&&(r.holderEl=a.one(n.placeholderEl)),r.maxItemCount=r.maxItemCount||e.maxItemCount,r},_initCombo:function(){var e,t,a=this,n=a._getDataSourceCfg(),r=a.get("sugConfig");a._getRenderMods(),r.sourceUrl?(e=new c.RemoteDataSource(n),e.maxItemCount=10):(e=new c.LocalDataSource(n),e.maxItemCount=0),a._setComboCache(e),t=a._getComboCfg(e);var o=new c(t);o.render(),a.comboBox=o,a._checkHasTab(),a._initComboEvent()},update:function(e){for(var t=this,a=t.get("plugins"),n=0,r=a.length-1;r>=n;n++){var o=a[n];o&&KISSY.isFunction(o.update)&&o.update.call(o,e)}},parse:function(e,t){var a,n=this,r=n.fire("beforeParse",{results:t,query:e});if(r===!1)return[[""]];if(r&&(t=r),!t||!t.result)return KISSY.log("接口无数据!"),[[""]];a=t.result,delete t.result;var o=n.comboBox.get("dataSource");if((o.extraData||(o.extraData=[]))[e]=t,0===a.length)return[[""]];for(var i in a)a[i]||a.splice(i,1);return a},format:function(e,t){var a=this;return a.resultArr=[],a.render(e,t),a.resultArr},render:function(e,t){var a,n,r,o,i,s,u=this,l=u.get("mods"),c=l.sort,d=u._adjustExtra(e,l.showExtra);u.query=e;for(var f=0,g=c.length-1;g>=f;f++)if(s=c[f])if("list"!==s){if(i=u.getPlugin(s),i&&i.renderPlugin)i.renderPlugin({query:e,results:t});else if(n=l[s],n&&d&&(!(o=n.pos)||r!==o)){if(a=n.tmpl,!a)continue;var p=u.resultArr.length,h=u.diffLen||0;r=u.defaultRender({tmpl:a,name:s,pos:o,always:n.always&&t.length>0,callback:n.callback,index:p-h})}}else n=l[s],a=n.tmpl,u._list(e,t,a);u.fire("afterQueryChange",{query:e})},defaultRender:function(e){var t,a=this,n=e.tmpl,r=e.name,o=a.comboBox.get("dataSource"),i=a.query,s=a.get("sugConfig").prefixCls,u=o.extraData,l=e.pos,c=e.index;if(u&&u[i]||e.always){var d,f,g=a._getDate(),p={$query:i,$queryUrl:encodeURIComponent(i),$date:g,prefixCls:s};if(!e.always){if(d=u[i][r],f=!0,!d)return;if(KISSY.isArray(d)){d.length>2&&(d.length=2);for(var h=0,m=d.length;m>h;h++){var v=d[h];if(KISSY.isArray(v)){f=!1;for(var b=0,y=v.length;y>b;b++)p["$"+b]=v[b]||"";p.$3=encodeURIComponent(p.$2),p.$index=c+1+h,t=KISSY.substitute(n,p),a.addContent({html:t,query:i,position:l,callback:e.callback})}else p["$"+h]=v,p.$index=c+1+h}return f&&(t=KISSY.substitute(n,p),a.addContent({html:t,query:i,position:l,callback:e.callback})),l}if(KISSY.isObject(d)){for(var S in d)p[r+"_"+S]=d[S];"active"===r&&(p.$query=d.query+" "+d.tag)}else p[r]=d,p.$query=d}return p.$index=c+1,t=KISSY.substitute(n,p),a.addContent({html:t,query:p.$query||i,position:l,callback:e.callback}),l}},_adjustExtra:function(e){return""!==e?!0:!1},getNick:function(){var e=this;return e._getCookie("lgc")||e._getCookie("tracknick")},_getCookie:function(e){var t=window;if(t.userCookie&&!KISSY.isUndefined(t.userCookie[e]))return t.userCookie[e];if(t.SRP_COOKIES||(t.SRP_COOKIES={})&&KISSY.isUndefined(SRP_COOKIES[e])){var a=document.cookie.match("(?:^|;)\\s*"+e+"=([^;]*)");a&&a[1]?SRP_COOKIES[e]=decodeURIComponent(a[1]):SRP_COOKIES[e]=""}return SRP_COOKIES[e]},_getDate:function(){var e=new Date;return e.getFullYear()+"-"+(e.getMonth()+1)+"-"+(e.getDate()+1)},_list:function(e,t,a){var n,r=this,o=r.get("sugConfig").resultFormat,i=r.resultArr||(r.resultArr=[]);KISSY.each(t,function(r,s){if(!r||!r[0])return void t.splice(s,1);var u,l=r[0],c="",d=e;if(l.match(/<b>/))n=l.replace(/<b>(\S+?)<\/b>/g,function(e,t){return t}),c=l,l="";else{for(;l.indexOf(d)<0;)d=d.substr(0,d.length-1);""===d?(c=l,l=""):0===l.indexOf(d)?(c=d,l=l.replace(d,"")):(c=l,l=""),n=r[0]}for(var f in i)if(u=i[f],u.textContent===r[0]&&u.unique)return;a=a.replace("{format}",o),i.push({textContent:n,content:KISSY.substitute(a,{query:c,text:l,index:s+1,count:r[1],textContent:encodeURIComponent(n)}),list:!0})}),r.resultArr=i},addContent:function(e){var t=this,a=e.html,n=e.position,r=e.query;if(!n){var o=t.resultArr||[];return void o.push({content:a,textContent:r})}t["__"+n]={tmpl:a},t._addExtraEvent()},_renderHeader:function(e,t,n){var r=t&&t.type+"-header"||"";if(t){var o=this.get("sugConfig").prefixCls;e||(e=new a("<div class='"+o+"combobox-menu-header "+r+"'></div>").prependTo(n)),e.empty().append(t.tmpl)}else e&&e.remove()},_renderFooter:function(e,t,n){var r=this,o=r.get("sugConfig").prefixCls,i=t&&t.type+"-footer"||"";if(t){e||(e=new a("<div class='"+o+"combobox-menu-footer "+i+"'></div>").appendTo(n)),t.css&&e.css(t.css),e.empty().append(t.tmpl);var s=e.one("."+o+"menu-history-clean");s&&s.on("click",function(e){e.halt();var t=r.getPlugin("history");t._cleanHistory()})}else e&&e.remove()},_addExtraEvent:function(e){var t=this,a=t.comboBox||t,n=t.__header,r=t.__footer,o=t.__lastHeader,i=t.__lastFooter,s=t.get("sugConfig").prefixCls;if(!e||e&&!e.newVal){var u=a.get("menu");if(!u.get)return;var l=u.get("el");if(!l||l.all("."+s+"menuitem").length<1)return;var c=l.one("."+s+"combobox-menu-header"),d=l.one("."+s+"combobox-menu-footer");o!==n&&(t.__lastHeader=n,t._renderHeader(c,n,l)),i!==r&&(t.__lastFooter=r,t._renderFooter(d,r,l))}else t.__header=null,t.__footer=null}},{ATTRS:{sugConfig:{value:{extraPassParams:"",extraPostParams:"",sourceUrl:"",tab:"item",autoCollapsed:!0,focused:!1,prefixCls:"search-",excludeParam:["q"],resultFormat:"约{count}个宝贝"},setter:function(e){var t=this.get("sugConfig");return KISSY.mix(t,e,void 0,void 0,!0)}},mods:{value:{},setter:function(e){return e}},input:{getter:function(e){return e?e:this.comboBox?e=this.comboBox.get("input"):void 0}},form:{getter:function(e){return e?e:this.get("input")?e=this.get("input").parent("form"):void 0}},label:{getter:function(e){return e?e:this.comboBox?e=this.comboBox.get("holderEl"):void 0}},menu:{getter:function(e){return e?e:this.comboBox?e=this.comboBox.get("menu"):void 0}},dataSourceCfg:{value:{xhrCfg:{url:"",dataType:"jsonp",scriptCharset:"utf-8",data:{code:"utf-8"}},allowEmpty:!0,paramName:"q",cache:!0}},statConfig:{value:{tongjiKey:{logkey:"/tongji",chksum:"H51884970"},pvKey:{logkey:"/search",chksum:"H51884969"},unicode:!1},setter:function(e){var t=this.get("statConfig");return KISSY.mix(t,e,void 0,void 0,!0)}},placeholder:{value:{show:!1,node:null}}}});return e=C}(),n.exports=f});KISSY.add("tbc/search-suggest/6.1.3/plugin/history",["base","node","event","tbc/search-suggest/6.1.3/mods/local-query"],function(e,t,r,i){function n(e){n.superclass.constructor.call(this,e||{}),KISSY.sug=KISSY.bind(this._retSug,this)}var a=t("base"),o=t("node");t("event");var s,l=t("tbc/search-suggest/6.1.3/mods/local-query");KISSY.extend(n,a,{pluginInitializer:function(e){var t=this,r=e.get("sugConfig"),i=r.tab||"";s=e.Stat,e.set("extend",{history:!0}),t.set("caller",e),t.localQueryMap={},t.localQueryPinyingMap={},t.historyLocalQuery=t.localQueryMap[i]=new l({name:"history",tab:i,user:e.getNick()}),t.pinyingLocalQuery=t.localQueryPinyingMap[i]=new l({name:"pinyin",tab:i,user:e.getNick()}),t.hitedHistoryListMap={};var n=e.comboBox;setTimeout(function(){t.historyLocalQuery.checkFlash({onSuccess:function(){t.historyReady=!0,n.on("afterCollapsedChange",function(e){if(!e.newVal){n.detach("afterCollapsedChange",arguments.callee);var i=n.get("menu").get("el");i.delegate("mousedown","."+r.prefixCls+"menu-history-delete",t._historyDeleteMousedown,t)}}),e.on("beforeSubmit",function(e){var r=n.get("input").val(),i=e.isNotSave;""===KISSY.trim(r)||r.match(/[<>'"]/g)||t.pinyingLocalQuery&&!i&&t.pinyingLocalQuery.save(r,KISSY.trim(r))}),setTimeout(function(){t._getPinyinQuery()},1e3)},onFailure:function(){KISSY.log("loading flashStorage failure!")}})},500)},_dealUrl:function(e,t){var r="&area=history",i=e.indexOf(r)>-1;return t?!i&&e+r:i&&e.replace(r,"")},_getPinyinQuery:function(){var e=this,t=e.historyLocalQuery,r=e.pinyingLocalQuery.query();if(r.length>0){var i=decodeURIComponent(r[0].key);/[\u4e00-\u9fa5]/.test(i)?(e._getPinyin(r[0].key),e.pinyingLocalQuery.clearByDay(0)):(e.pinyingLocalQuery.clearByDay(0),t.save(i,KISSY.trim(i)))}},_renderHTML:function(e,t){var r,i=this,n=i.get("caller"),a="",o=n.get("mods").history.tmpl,t=t||{},s=n.resultArr||(n.resultArr=[]),l=[];e=KISSY.unique(e);for(var u=0,c=e.length-1;c>=u;u++)0!==u&&(t.attr=""),t.index=(u+1).toString(),t.historyItemValue=decodeURIComponent(e[u].key),t.historyItemQuery=e[u].key,a=KISSY.substitute(o,t),r=t.historyItemValue,l.push(r),s.push({content:a,textContent:r,unique:!0});n.historyArr=l},renderPlugin:function(){if(this.historyReady){var e,t,r=this,i=r.get("caller"),n=i.query,a=r.historyLocalQuery.query(n),o=r.get("limit"),s=i.get("sugConfig"),l=i.comboBox.get("dataSource"),u=l.extraData&&l.extraData[n];if(r.get("web")&&""===n&&u&&u.cloud)return void r._renderHTML(u.cloud,{prefixCls:s.prefixCls});""===n&&a.length>0?(i.__header={tmpl:'<div class="history-box"><span>最近搜过</span></div>',type:"history"},i.__footer=null,e=o):(i.__header=null,i.__footer=null,e=2),t=a.splice(0,e),i._addExtraEvent(),r._renderHistoryItems(t),r.hitedHistoryListMap[n]=t}},_historyDeleteMousedown:function(e){for(var t=this,r=t.get("caller"),i=o.one(e.target),n=i.parent().attr("data-value"),a=i.parent(2),s=r.comboBox,l=s.get("menu"),u=l.get("children"),c=i.attr("data-type"),y=0;y<u.length;y++){var g=u[y];if(g.get("el")[0]===a[0]){l.removeChild(g,!0);break}}var d=t.historyLocalQuery;d&&("history"===c?d.deleteItem(n):"most"===c&&(d._setKey({name:"most"}),d.save(n,n),d._setKey({name:"history"}))),s.sendRequest(r.query),t._sendStat(n)},_sendStat:function(e){var t,r=this.get("caller"),i={},n=location.hostname,a="op=del&nk={nick}&src={host}&q={query}&app=sug";i.nick=r.getNick(),i.query=e,i.host=n.replace(/com|\./g,""),t=KISSY.substitute(a,i),s&&s.send(t)},_renderHistoryItems:function(e,t){var r=this,i={},n=r.get("caller"),a=n.get("sugConfig");i.prefixCls=a.prefixCls,i.attr=t&&t.attr||"",i.extraParam=t&&t.param||"history",r._renderHTML(e,i)},_getPinyin:function(e){var t=this,r=location.protocol+"//suggest.taobao.com/sug?code=utf-8&area=py&callback=KISSY.sug&q="+e;t._savedInputValue=decodeURIComponent(e),KISSY.getScript(r)},_retSug:function(e){if(e&&e.result){var t=e.result[0],r=this,i=r._savedInputValue;r.historyLocalQuery&&r.historyLocalQuery.save(i,KISSY.trim(t))}},_cleanHistory:function(){var e=this,t=e.get("caller"),r=t.comboBox,i=r.get("menu"),n=i.get("el"),a=r.get("input"),o=t.get("sugConfig"),s=o.prefixCls,l=n.one("."+s+"combobox-menu-header");e.historyLocalQuery.clearByDay(0),e.hitedHistoryListMap={};var u=l.siblings();u.css("display","none"),l.html('<div class="history-box"><span>搜索历史已清空</span></div>');var c=new KISSY.Anim(n,{opacity:0},3,"easeIn",function(){u.css("display","block"),n.css({opacity:1,visibility:"hidden"})});c.run(),a.on("blur keydown mousedown",function(e){c.isRunning()&&c.stop(!0),t.__header=null,t.__footer=null,"keydown"===e.type&&this.value&&n.css("visibility","visible"),a.detach("blur keydown mousedown",arguments.callee)})},update:function(e){var t=this,r=encodeURI(e.tab);t.localQueryMap[r]||(t.localQueryMap[r]=new l({name:"history",tab:r,user:t.get("caller").getNick()}),t.localQueryPinyingMap[r]=new l({name:"pinyin",tab:r,user:t.get("caller").getNick()})),t.pinyingLocalQuery=t.localQueryPinyingMap[r],t.historyLocalQuery=t.localQueryMap[r],t._getPinyinQuery()}},{ATTRS:{pluginId:{value:"history"},limit:{value:10,setter:function(e){return KISSY.isNumber(e)?e:void 0}}}}),i.exports=n});KISSY.add("tbc/search-suggest/6.1.3/plugin/cloud",["base","dom","node","event","cookie","tbc/search-suggest/6.1.3/mods/menu","tbc/search-suggest/6.1.3/tpl/cloud"],function(e,t,n,a){function r(e){r.superclass.constructor.call(this,e||{})}var o=t("base"),i=t("dom"),s=t("node"),l=t("event");t("cookie");var u,d,c=t("tbc/search-suggest/6.1.3/mods/menu"),h=t("tbc/search-suggest/6.1.3/tpl/cloud"),g=s.all;KISSY.extend(r,o,{pluginInitializer:function(e){var t,n,a=this,r=e.comboBox;a.isNotFirstRender=[],a.count=0,u=e,d=a.Stat,a.set("caller",e),a.initKeyEvent();var o=i.children(e.get("el")),l=e.get("form")[0],h=i.attr(l,"action"),g=i.attr(o,"data-action")||e.get("action")||h;a.set("action",g),r.on("beforeShow",function(){if(a.isShowFirstItem){var e=r.get("menu"),t=n.get("children");e.set("highlightedItem",t[0]),a.show(t[0].get("el")[0])}else a.setCloudHeight()}),e.on("afterCollapsedChange",function(r){r.newVal||(e.detach("afterCollapsedChange",arguments.callee),a.mouseArr=[],n=e.get("menu"),t=n.get("el"),t.addClass("search-cloud-menu"),a.initMenu||(s.one(".search-menu")&&(a.initMenu=!0,a.menu=new c({wrap:".search-menu",menu:".search-contentbox,.search-menu-content",rows:".search-menuitem",cls:".search-wrap-cloud",tolerance:500,handler:{enterHandler:function(t){e.fire("beforeCloudShow",{inst:a,el:t})!==!1&&a.show(t)},leaveHandler:function(e){a.hide(e)}}})),n.on("afterHighlightedItemChange",function(){a.setCloudHeight()}),a.initMouseEvent(t)))})},initMouseEvent:function(e){return e?void e.delegate("click",".cloud-list a",function(e){var t=e.currentTarget,n=t.getAttribute("href");n&&(n=u.urlEncode(n),t.setAttribute("href",n))}):!1},show:function(e){var t=this;t._showCloud(e),t.setCloudHeight()},hide:function(){this._hideCloud()},setCloudHeight:function(){var e,t=u.get("menu").get("el"),n=s.one(".cloud-footer");if(t.width()<500?t.addClass("narrow-suggest-menu"):t.removeClass("narrow-suggest-menu"),n){if(e=n.one(".cloud-box"),e.css("height","auto"),t.css("height","auto"),e){var a=t.height(),r=e.height();r>a?t.height(r-1):(t.css("height","auto"),e.css("height","100%"))}}else t.css("height","auto")},_hideCloud:function(){g(".cloud-footer").hide(),g(".search-menu-item-hover").removeClass("search-menu-item-hover")},_showCloud:function(e){var t,n,a,r=this,o=g(".search-wrap-cloud",e),i=s.one(".cloud-footer");g(".search-menu-item-hover").removeClass("search-menu-item-hover"),g(e).addClass("search-menu-item-hover"),r.lastItemIndex&&(n=s.one("#J_CloudList"+r.lastItemIndex),n&&n.hide(),i&&i.hide()),o.length&&(t=o.attr("data-index")||o.one("div").attr("data-index"),r.lastItemIndex=t,n=s.one("#J_CloudList"+t),n&&(a=n.attr("data-align"),r.set("align",!("true"!==a)),n.show(),i&&i.show(),r.setPadding(g(e),n)))},_sendStat:function(){var e="f_stats_show=magic:1",t=u.get("sugConfig").sourceUrl,n="";t&&t.match(/bucketid=\w+/)&&(n=t.match(/bucketid=(\w+)/)[1],e+=";bts:"+n),d&&d.send(e,!0)},getPadding:function(e,t){var n=32,a=s.one(".search-menu"),r=a.offset().top,o=e.offset().top,i=o-r,l=a.height(),u=t.height(),d=i-n,c=l-u-d-10;return d>0?c>=0?d:d-=39*Math.round(-c/39):void 0},initKeyEvent:function(){var e=this,t=u.comboBox,n=l.KeyCodes||s.KeyCode;t.on("beforeKeyDown",function(a){var r=this.get("menu");if(r.get){var o,i,l,d,c=a.event,h=r.get("highlightedItem"),g=r.get("children"),m=g.length;if(0===m)return void 0;switch(c.keyCode){case n.ENTER:var v=e.isShowMagic(),f=e.isShowItem(),p=v||f;return p&&(c.halt(),!v&&f&&(KISSY.UA.ie>=10||0===KISSY.version.indexOf("6."))?h.fire("click"):p.click()),!1;case n.UP:case n.DOWN:var w,S;c.keyCode===n.UP?(S=m-1,w=-1):(S=0,w=1),e.isTriggerArrowKey=!0,h?(o=KISSY.indexOf(h,g),i=(o+w+m)%m):i=S;var I=s.one(".cloud-link-wrap-hover");return I&&I.removeClass("cloud-link-wrap-hover"),0===o&&-1===w||o===m-1&&1===w?(e._hideCloud(),r.set("highlightedItem",null),t._stopNotify=1,u.get("input").val(t._savedInputValue||t._savedValue),!1):(l=r._getNextEnabledHighlighted(i,w),r.set("highlightedItem",l),e.show(l.get("el")[0]),t._stopNotify=1,d=l.get("textContent"),t.setValueFromAutocomplete?t.setValueFromAutocomplete(d):(t._stopNotify=1,u.get("input").val(d)),t.fire("beforeSetInputValue",{event:c}),!1);case n.HOME:case n.END:return l=c.keyCode===n.END?r._getNextEnabledHighlighted(m-1,-1):r._getNextEnabledHighlighted(0,1),r.set("highlightedItem",l),e._showCloud(l.get("el")[0]),t.setValueFromAutocomplete?t.setValueFromAutocomplete(l.get("textContent")):(t._stopNotify=1,u.get("input").val(l.get("textContent"))),!1;default:e.directionEvent(c)}}})},isShowMagic:function(){var e,t,n,a=g(".J_cloud-handle");return a.each(function(t){var n=s.all(t);"none"!==i.css(n,"display")&&(e=n)}),e?(t=i.query(".cloud-link-wrap-hover")[0],t&&(n="a"===t.tagName.toLowerCase()?t:i.query("a",t)[0]),n):void 0},isShowItem:function(){var e=this;return e.isTriggerArrowKey&&i.get(".search-menu-item-hover")},directionEvent:function(e){var t,n,a,r,o,i=this;switch(e.keyCode){case 39:case 37:if(o=u.get("menu"),t=o.get("activeItem")||o.get("highlightedItem"),!t)return!0;if(n=t.get("el").one(".item-wrapper"),!n)return!0;if(a=n.attr("data-index"),!a)return!0;if(r=s.one("#J_CloudList"+a),!r)return!0;var l=e.keyCode-37?"next":"prev";i.getHighLightItem(r,l)}},getHighLightItem:function(e,t){var n=e.one(".cloud-link-wrap-hover");if(n){var a=parseInt(e.attr("data-select-index")),r=e.all(".cloud-link");a="next"===t?a<r.length-1?a+1:0:a>0?a-1:r.length-1,n.removeClass(".cloud-link-wrap-hover");var o=r.item(a);e.attr("data-select-index",a),o.parent().addClass("cloud-link-wrap-hover")}else{var i=e.one(".cloud-link").parent();i&&i.addClass("cloud-link-wrap-hover"),e.attr("data-select-index",0)}},setPadding:function(e,t){var n=this,a=t.one(".inner-wrap"),r=this.getPadding(e,a),o=n.get("align");o&&r&&a.css("paddingTop",r)},checkRender:function(e){var t,n=this,a=e.comboBox,r=e.query,o=a.get("dataSource"),i=o.extraData[r],s=e.resultArr;return t=""!==r&&i?{extra:i,query:r,results:s}:!1,n.extraData=i,n.isShowFirstItem=!1,t},isAutoShow:function(e){return!!(KISSY.isArray(e)&&e.length>0&&(e[0].list||e[0].tag))},renderPlugin:function(){var e=this,t=e.checkRender(u);if(!t)return!1;var n,a,r,o,i,s,l,d,c="",h=t.extra,g=t.results,m=t.query;e.isFirstShow=!1,n=KISSY.clone(h.magic);for(var v=e.isAutoShow(u.resultArr),f=0,p=g.length-1;p>=f;f++)if(a=g[f],i=a.content,r=i.match(/data-index='(\w+)'/),o=i.match(/data-key='([\S\s]+?)'/),r&&r[1]){r=r[1]-0,o&&o[1]&&(o=o[1]);for(var w in n)s=n[w],r===s.index-0&&(e._wrapItem(a,o),d=e._renderHTML({data:s,query:m,index:r,key:o,auto:v,type:s.type||"tag",tagTitle:decodeURIComponent(o.match(/q=([^&]+)/)[1]),action:e.get("action")}),d&&(c+=d),1===r&&d&&(l=!0))}var S={tmpl:'<div class="cloud-box">'+c+"</div>",type:"cloud"};if(v&&l?(S.css={display:"block"},e.isShowFirstItem=!0):(S.css={display:"none"},e.isShowFirstItem=!1),KISSY.UA.ie<7){var I=u.resultArr.length;S.css.height=26*I}u.__footer=S,u._addExtraEvent(),e.isTriggerArrowKey=!1},_wrapItem:function(e,t){var n;KISSY.isObject(e)&&(n=e.content,e.content="<div class='search-wrap-cloud' data-key='"+t+"'>"+n+"</div>")},_renderHTML:function(e){var t,n,a,r=this,o={},i=e.data,s=e.query,l=e.index,u=r.extraData,d=e.type,c=e.auto&&1===l?"style='display:block'":"";if(u&&u.event&&1===l)t=r.get("event-tmpl"),n=r.get("event-param");else{if(!d)return KISSY.log("魔盒类型不存在!"),c="",!1;if(a=r.get(d),!a)return KISSY.log("接口返回的类型"+d+"不存在对应的模板"),c="",!1;t=a.tmpl,a.length&&i.data&&i.data.length>a.length&&(i.data.length=a.length),a.sort&&r.sort(i.data),n=r.get("param")}o.param=n?"&"+n:"",o.query=s,o.index=l,o.prefix=e.prefix||l,o.tagTitle=e.tagTitle,o.action=e.action,i.count&&i.count<=3&&(o.ishidden="hidden"),o=KISSY.merge(o,i),o.autoAttr=c;var h=t(o);return h},sort:function(e){Array.prototype.sort.call(e,function(){return Math.random()>.5?-1:1})}},{ATTRS:{pluginId:{value:"cloud"},limit:{value:3,setter:function(e){return KISSY.isNumber(e)?e:void 0}},tag:{value:{tmpl:h.tag,sort:!0,length:10}},tag_group:{value:{tmpl:h.tag_group,length:10}},navi:{value:{tmpl:h.navi}},spu:{value:{tmpl:h.spu,length:3}},topbrand:{value:{tmpl:h.topbrand}},qrcode:{value:{tmpl:h.qrcode}},align:{value:!0}}}),a.exports=r});KISSY.add("tbc/search-suggest/6.1.3/plugin/history-magic",["base","dom","ajax","tbc/search-suggest/6.1.3/mods/bts"],function(t,e,a,i){function r(t){r.superclass.constructor.call(this,t||{})}var o=e("base"),u=e("dom"),n=e("ajax"),s=e("tbc/search-suggest/6.1.3/mods/bts");KISSY.extend(r,o,{pluginInitializer:function(t){var e=this,a=t.getPlugin("cloud"),i=500;this.sug=t,e.set("cloudPlugin",a),e.set("caller",t);var r;t.on("afterQueryChange",function(){r&&clearTimeout(r),e.isGetData&&(i=0),r=setTimeout(function(){var i=t.get("menu").get("el");e.getPostData(i,function(t){if(t){var e=u.get(".search-menuitem");a.show(e)}})},i)})},getPostData:function(t,e){var a=this,i=".search-menu-history-key",r=u.query(i,t),o=u.query(".search-menu-extras-history",t),n=[],s=[],c=[],l=a.historyData||{},g=!0;if(!r)return!0;for(var d=0,h=o.length-1;h>=d;d++){var f=u.text(r[d]);n.push(u.attr(o[d],"data-index")),l[f]?l[f].index=d+1:(s.push(f),l[f]={}),c.push(f)}a.historyData=l,0===s.length&&(g=!1);var v,x={text:c,index:n,el:o,result:{content:u.outerHTML(t)}};if(g)v=a.getMagicData(x,function(t){e.call(this,t)});else{var p=a.getLocalData(c);a.render(x,p,function(t){e.call(this,t)})}return v},getLocalData:function(t){for(var e,a={},i=this.historyData,r=0;r<t.length;r++)e=t[r],a[e]=i[e];return a},getMagicData:function(t,e){var a=this,i=t.text,r=a.get("dataUrl"),o=r.replace("{query}",i.join("%01"));-1===o.indexOf("bucketid")&&(o+="&bucketid="+(new s).getBucket()),n.jsonp(o,function(i){a.isGetData=!0,a.render(t,i.magic,e,!0)})},render:function(t,e,a){var i,r,o,n,s=this,c=s.get("cloudPlugin"),l=t.text,g=t.index,d=t.el,h=!1;if(!e)return!0;s.checkCloudBox();for(var f in e){var v=e[f],x=v.index-0;v.data&&(r="_his_"+x,n=KISSY.indexOf(r,g),o=l[n]||f,s.historyData[o]=e[f],n>-1&&u.addClass(d[n],"search-wrap-cloud"),i=c._renderHTML({result:t.result,data:e[f],query:o,index:r,key:o,auto:!1,type:e[f].type||"tag",tagTitle:o,prefix:r,action:s.sug.userConfig&&s.sug.userConfig.action}),u.get("#J_CloudList"+r)&&u.remove("#J_CloudList"+r),u.append(u.create(i),".cloud-box"),1===x&&(h=!0))}a.call(this,h)},checkCloudBox:function(){var t=this.get("caller"),e=t.get("menu").get("el");if(e&&!u.get(".cloud-box")){var a='<div class="search-combobox-menu-footer cloud-footer"><div class="cloud-box" style="height: auto"></div></div>';e.append(a)}},update:function(){}},{ATTRS:{pluginId:{value:"historyMagic"},dataUrl:{value:location.protocol+"//suggest.taobao.com/sug?area=history_magic&q={query}"},cloudPlugin:{value:null}}}),i.exports=r});KISSY.add("tbc/search-suggest/6.1.3/plugin/tab",["node","base","dom","event","combobox"],function(t,a,o,e){function r(t){r.superclass.constructor.call(this,t||{})}var s=a("node"),i=a("base"),c=a("dom"),n=a("event"),l=a("combobox");KISSY.extend(r,i,{pluginInitializer:function(t){this.tabConfig={},this._initPluginEvent.call(this,t)},tabClick:function(t){var a,o,e=this,r=e.get("caller"),i=t.currentTarget,n=c.attr(i,"data-searchtype"),l=c.attr(i,"data-defaultpage"),g=c.attr(i,"data-action"),u=r.comboBox.get("input"),f=c.parent(u,"form"),b=e.get("activeCls"),d=c.get("label",f),m=e.tabConfig;if(r.fire("beforeTabChange",{el:i,labelType:n})===!1)return!1;if(c.removeClass(c.siblings(i),b),c.addClass(i,b),r.tabNode=s.one(i),l&&f.setAttribute("data-defaultpage",l),g&&f.setAttribute("action",g),n){if(o=m[n]||e.getDefCfg(n),!o)return!1;g&&(o.action=g),r.update(o),e.tabConfig&&!e.tabConfig[n]&&e.saveTabConfig(o)}else{var C=r.query||u.val(),h=c.get("a",i);if(h){var p=c.attr(h,"href");p=p.replace("/?","/search?"),p=p+"&q="+C,c.attr(h,"href",p)}}d&&(a=d.getAttribute("data-searchtype-"+n)||"",d.innerHTML=a),t.preventDefault()},_initPluginEvent:function(t){var a=this,o=a.get("activeCls"),e=a.get("node")||t.get("sugConfig").tablist;a.set("caller",t),e&&(n.on(e,"click",a.tabClick,a),s.all(e).each(function(a){var e=s.all(a);e.hasClass(o)&&(t.tabNode=e)}),a.saveTabConfig())},saveTabConfig:function(t){var a,o,e=this,r=e.get("caller"),s=r.get("form");a=r.tabNode.attr("data-searchtype"),o=r.userConfig||{},o.mods=r.get("mods"),o.tab=a,o.action=s.attr("action"),o.defaultpage=s.attr("data-defaultpage"),e.tabConfig||(e.tabConfig={}),e.tabConfig[a]=KISSY.clone(o),t&&t.sugConfig&&t.sugConfig.sourceUrl&&e.tabConfig[a].sugConfig&&(e.tabConfig[a].sugConfig.sourceUrl=t.sugConfig.sourceUrl,e.tabConfig[a].tab=a)},update:function(t){var a,o,e=this,r=e.get("caller"),s=r.comboBox,i=t.tab,n=r.configArr[i],g=t.sugConfig,u=s.get("input"),f=c.parent(u,"form");r.configArr=r.configArr||[],a=r.get("dataSourceCfg"),o=a.xhrCfg,o.url=g.sourceUrl,r.__attrVals.mods.sort=t.mods.sort,n||(n=""===o.url?r.configArr[i]={data:new l.LocalDataSource({data:{},parse:a.parse})}:r.configArr[i]={data:new l.RemoteDataSource(a)}),s.set("maxItemCount",o.url?10:0),s.set("dataSource",n.data),f&&c.attr(f,"action",t.action),u[0].focus();var b=u.val();b&&s.sendRequest(b)},getDefCfg:function(t){var a;switch(t){case"shop":a={sugConfig:{sourceUrl:location.protocol+"//suggest.taobao.com/sug?area=ssrch&k=1",resultFormat:"",tab:"shop",excludeParam:["q"]},mods:{sort:["history","list"],showExtra:!1},action:location.protocol+"//shopsearch.taobao.com/search",tab:"shop"};break;case"item":a={sugConfig:{sourceUrl:location.protocol+"//suggest.taobao.com/sug?area=c2c&k=1",resultFormat:"",tab:"item",excludeParam:["q"]},mods:{sort:["history","cat","global","list","shop"]},tab:"item",action:location.protocol+"//s.taobao.com/search"};break;case"mall":a={sugConfig:{sourceUrl:location.protocol+"//suggest.taobao.com/sug?area=b2c&k=1",resultFormat:"",tab:"mall",excludeParam:["q"]},mods:{sort:["history","cat","global","list"]},tab:"mall",action:location.protocol+"//list.tmall.com/search_product.htm"};break;default:KISSY.isObject(t)?(a=t,a.sugConfig||(a.sugConfig={})):KISSY.isString(t)&&(a={sugConfig:{sourceUrl:location.protocol+"//suggest.taobao.com/sug?area=c2c&k=1",resultFormat:"",tab:t,excludeParam:["q"]},mods:{sort:["history","list"]},action:null})}return a.sugConfig&&!a.sugConfig.tab&&(a.sugConfig.tab=a.sugConfig.sourceUrl),a}},{ATTRS:{pluginId:{value:"tab"},caller:{value:null}}}),e.exports=r});KISSY.add("tbc/search-suggest/6.1.3/plugin/imgsearch",["node","base","kg/uploader/3.0.3/index","kg/uploader/3.0.3/plugins/auth/auth","kg/uploader/3.0.3/plugins/filedrop/filedrop","tbc/search-suggest/6.1.3/mods/stat"],function(e,a,o,n){var t=a("node"),r=a("base"),i=a("kg/uploader/3.0.3/index"),l=a("kg/uploader/3.0.3/plugins/auth/auth"),u=a("kg/uploader/3.0.3/plugins/filedrop/filedrop"),s=a("tbc/search-suggest/6.1.3/mods/stat"),d=new s;n.exports=r.extend({initializer:function(){},pluginInitializer:function(e){var a=this;a.sug=e;var o=a.comboBox=e.comboBox,n=o.get("prefixCls"),t=a.wrap=o.$el.one("."+n+"combobox-input-wrap");t&&t.length>0&&a._renderImgsearch()},_renderImgsearch:function(){var e=this,a=t.one(e.get("query")),o=a.parent("form"),n=t.one(e.get("panel"));e._panelNode=n,e._formNode=o,e._initUploader(),e._bindEvent(),e._bindTabChange()},_initUploader:function(){var e=this,a={max:3,maxSize:5120,allowRepeat:!1,required:!0},o=e.get("authConfig");o=KISSY.merge(a,o);var n=e.get("uploadUrl"),t=e.get("type"),r={action:n,type:t,btnTpl:'<a target="_self" href="javascript:void(0)" class="g-u ks-uploader-button"><span class="btn-text">{text}</span></a>'};"iframe"===t&&(r.data={cross:"taobao"});var s=new i(e.get("input"),r),p=e.get("theme");if(!p)throw new Error("缺少主题");e._panelNode.on("click",function(e){e.target&&"INPUT"===e.target.tagName.toUpperCase()&&d.send("f_stats_show=ps_upload:2",!0)}),s.theme(p),s.plug(new l(o)).plug(new u),s.on("select",function(){return e.sug.fire("beforeImageSelect")===!1?!1:void 0}),s.on("start",function(){"iframe"===e.get("type")&&(e.oldDomain=document.domain||location.host,document.domain="taobao.com")}),s.on("success",function(a){return d.send("f_stats_show=ps_upsucc:1",!0),e.sug.fire("beforeImageSuccess",{data:a})===!1?!1:(e._formNode.all("input[name=tfsid]").remove(),e._formNode.all("input[name=app]").remove(),e._formNode.append('<input type="hidden" name="tfsid" value="'+a.result.name+'" />'),e._formNode.append('<input type="hidden" name="app" value="imgsearch" />'),void e._formNode[0].submit())});var c=s.getPlugin("auth");return c?(s.on("error",function(a){e.oldDomain&&(document.domain=e.oldDomain);var o=a.result&&a.result.errorCode||0;d.send("f_stats_show=ps_upsucc:"+o,!0),e.sug.fire("beforeImageError",{data:a})}),void s.on("cancel",function(){e.oldDomain&&(document.domain=e.oldDomain)})):!1},_bindEvent:function(){var e=this,a=e.comboBox.get("prefixCls");e._panelNode.on("mouseenter",function(){e._panelNode.addClass(a+"imgsearch-panel-hover")}),e._panelNode.on("mouseleave",function(){e._panelNode.removeClass(a+"imgsearch-panel-hover")})},_bindTabChange:function(){var e=this;e.sug.on("beforeTabChange",function(a){var o=a.labelType;"item"!==o?e.available(!1):e.available(!0)})},available:function(e){var a=this;e?a._panelNode.show():a._panelNode.hide()}},{ATTRS:{pluginId:{value:"imgSearch"},panel:{value:"#J_UploaderPanel"},uploadUrl:{value:"//s.taobao.com/image"},input:{value:"#J_IMGSeachUploadBtn"},query:{value:"#q"},authConfig:{value:{}},theme:{value:null},type:{value:"auto"}}})});KISSY.add("tbc/search-suggest/6.1.3/theme/pailitao/index",["node","kg/uploader/3.0.3/theme","ua","tbc/search-suggest/6.1.3/theme/pailitao/index.css"],function(e,a,s,t){function o(e){o.superclass.constructor.call(this,e)}var i=a("node"),r=a("kg/uploader/3.0.3/theme"),l=a("ua");a("tbc/search-suggest/6.1.3/theme/pailitao/index.css"),KISSY.extend(o,r,{render:function(){var e=this,a=e.get("uploader");a.set("theme",e),e._addThemeCssName(),e._tplFormHtml();var s=e.get("queueTarget");if(!s)throw new Error("拍立淘主题 queueTarget 未设置!");if(e._rootNode=i.all(s),0===e._rootNode.length)throw new Error("拍立淘主题 queueTarget ("+s+") 节点位找到!");var t=e.get("formNode");if(e._formNode=i.all(t),0===e._formNode.length)throw new Error("拍立淘主题 formNode ("+t+") 节点未找到!");var o=e.get("qNode");if(e._qNode=e._formNode.one(o),!e._qNode)throw new Error("拍立淘主题 qNode ("+o+") 节点未找到!");e._qNode.on("focus",function(){e._hasMessageState&&e.hideMessage()}),8!==l.ie&&e._rootNode.on("focusout",function(){e._hasMessageState&&e.hideMessage()}),e._bind()},_appendFileDom:function(){return!1},_startHandler:function(){var e=this;e.showMessage("loading","<span>正在上传图片，请稍后...</span>")},_progressHandler:function(){},_errorHandler:function(e){var a=this,s="上传失败";"maxSize"===e.rule&&(e.result={errorMsg:"图片不能大于5M",errorInfo:"请换张图片试试"}),e.result||(e.result={});var t=e.result.errorMsg||"请重新上传试试",o=e.result.errorInfo||"";a.showMessage("error",s,t,o)},_completeHandler:function(){},showMessage:function(e,a,s,t){var o=this,i=o.get(e+"Tpl")||o.get("fileTpl"),r=KISSY.substitute(i,{title:a,msg:s||"",info:t||""});o._rootNode.html(r),o._rootNode.attr("tabindex",-1),o._rootNode.css("display","block");var l=o._rootNode.width();320>l?o._rootNode.addClass("imgseach-pailitao-theme-noicon"):o._rootNode.removeClass("imgseach-pailitao-theme-noicon"),o._rootNode[0].focus(),"error"===e&&(o._hasMessageState=!0,o.delayHideMessage(4))},delayHideMessage:function(e){var a=this;a.cleanDelayTimer(),a._delayTimer=setTimeout(function(){a.hideMessage()},1e3*e)},hideMessage:function(){var e=this;e._hasMessageState===!0&&(e._hasMessageState=!1),e._rootNode.css("display","none"),e.cleanDelayTimer()},cleanDelayTimer:function(){var e=this;e._delayTimer&&(clearTimeout(e._delayTimer),e._delayTimer=null)}},{ATTRS:{formNode:{value:"#J_SearchForm"},qNode:{value:"#q"},name:{value:"imgseach-pailitao-theme"},loadingTpl:{value:'<div class="pailitao-message pailitao-message-loading"><div class="pailitao-message-content"><div class="title" id="J_pailitaoMessageTitle">{title}</div></div></div>'},errorTpl:{value:'<div class="pailitao-message pailitao-message-error"><div class="pailitao-message-content"><div class="title" id="J_pailitaoMessageTitle">{title}</div><p class="msg">{msg}</p><p class="info">{info}</p></div></div>'},fileTpl:{value:'<div class="pailitao-message"><div class="pailitao-message-content"><div class="title" id="J_pailitaoMessageTitle">{title}</div><p class="msg">{msg}</p><p class="info">{info}</p></div></div>'},allowExts:{value:"jpg,png,gif,jpeg"},authMsg:{value:{max:"每次最多上传{max}个文件！",maxSize:"图片不能大于5M",widthHeight:"图片宽高需大于200",required:"至少上传一个文件！",allowExts:"不支持{ext}格式！",allowRepeat:"该文件已经存在！"}}}}),t.exports=o});