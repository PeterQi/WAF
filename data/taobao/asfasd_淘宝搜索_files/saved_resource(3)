KISSY.add("tbc/search-suggest/6.1.3/mods/local-query",["base","json","tbc/search-suggest/6.1.3/mods/storage"],function(t,e,a,s){function n(t){n.superclass.constructor.call(this,t||{}),this.initialize()}var i=e("base"),r=e("json"),o=e("tbc/search-suggest/6.1.3/mods/storage"),u="localQuery";KISSY.extend(n,i,{initialize:function(){var t=this,e=t.get("name"),a=t.get("tab"),s=t.get("user");"item"===a&&(a="baobei"),t.storageKey=u+e+a+s,t._getStorage()},checkFlash:function(t){this.storage.read(t)},_setKey:function(t){var e=this,a=t.name||e.get("name"),s=t.tab||e.get("tab"),n=t.user||e.get("user");"item"===s&&(s="baobei"),e.storageKey=u+a+s+n,e.set("tab",s),e.set("name",a),e.set("user",n),this.datalist=null},_save:function(t,e){if(!t.match(/<>'"/)&&!e.match(/<>'"/)){var a=this._getDatalist(),s=encodeURIComponent(t),n={key:s,value:encodeURIComponent(e),time:KISSY.now()};this._deleteItemByValue(a,s),a.unshift(n)}},_deleteItemByValue:function(t,e){for(var a,s=null,n=0;n<t.length;n++)a=t[n].key,a===e&&(s=t.splice(n,1),n--)},_query:function(t){var e,a,s=this._getDatalist(),n=[];return t?(t=encodeURIComponent(t),KISSY.each(s,function(s){e=s.key,a=s.value,(0===e.indexOf(t)||0===a.indexOf(t))&&n.push(s)}),this._distinctByValue(n)):this._distinctByValue(s)},_distinctByValue:function(t){for(var e,a=[],s=0,n=t.length;n>s;s++)e=t[s],e.value.match(/%3C|%3E|[<>'"]/g)||this._hasItemOfValue(a,e.value)||a.push(e);return a},_hasItemOfValue:function(t,e){for(var a=!1,s=t.length-1;s>=0;s--)t[s].value===e&&(a=!0);return a},_cleanBefore:function(t){for(var e,a=this._getDatalist(),s=0,n=a.length-1;n>=0;n--)if(e=a[n],e.time>t){s=n+1;break}a.length=s},_getDatalist:function(){return this.datalist||(this.datalist=this.storage.read()||[]),this.datalist},_getStorage:function(){var t=this.get("storageType");switch(t){case"flashStorage":this.storage=this._initFlashStorage();break;default:this.storage=!1}},_initFlashStorage:function(){var t=this;return{save:function(){return(new o).save(t.storageKey,r.stringify(t.datalist))},read:function(e){var a=(new o).read(t.storageKey,e);if(a){var s=r.parse(a);return s}return void 0}}},destructor:function(){this.datalist=null,u=null},save:function(t,e){if(""!==e){var a,s=this.storage.read();s&&(a=s.length);var n=this._save(t,e),i=this.storage.save();return a>300&&(this.datalist=this.datalist.slice(0,a-10),KISSY.log("add_before\n"+i+"\n"+a),i=this.storage.save(),KISSY.log("add_after\n"+i+"\n"+a)),n}},query:function(t){return this._query(t)},deleteItem:function(t){var e=this._getDatalist(),a=e.length;this._deleteItemByValue(e,encodeURIComponent(t));var s=this.storage.save();a>300&&(this.datalist=this.datalist.slice(0,a-10),s=this.storage.save(),KISSY.log("delete\n"+s+"\n"+a))},clearByDay:function(t){var e=KISSY.now()-24*t*3600*1e3;this._cleanBefore(e),this.storage.save()},hasHistory:function(){return this._getDatalist().length>0?!0:!1}},{ATTRS:{name:{value:"default",setter:function(t){return t}},user:{value:"",setter:function(t){return KISSY.fromUnicode(t)}},maxLength:{value:500},storageType:{value:"flashStorage",setter:function(t){return t},getter:function(t){return t}}}}),s.exports=n});KISSY.add("tbc/search-suggest/6.1.3/mods/menu",["node"],function(e,t,n,r){var o=t("node"),u=o.all,l=function(e){var t=this;t.opts=KISSY.mix(l.defs,e),t.$wrap=u(t.opts.wrap),t.$menu=u(t.opts.menu),t.locs=[],t.rNow=null,t.tOut=null,t.init()};l.defs={wrap:"",menu:"",rows:"",dealy:300,handler:null,tolerance:0},l.prototype.getOffset=function(){var e=this,t=e.opts,n=e.$menu,r=n.offset();e.menuOffset=r,e.upperRight={x:r.left+n.outerWidth(),y:r.top-t.tolerance},e.lowerRight={x:r.left+n.outerWidth(),y:r.top+n.outerHeight()+t.tolerance}},l.prototype.bindEvent=function(){var e,t,n,r=this,o=r.opts,l=r.locs,a=r.rNow,i=r.tOut,s=null,f=function(i){function f(e,t){return(t.y-e.y)/(t.x-e.x)}var c=!!u(i).one(o.cls);r.getOffset(),e=r.menuOffset,t=r.upperRight,n=r.lowerRight;var p=l[l.length-1],g=l[0];if(!a||!p)return 0;if(g.x<e.left||g.x>n.x||g.y<e.top||g.y>n.y)return 0;if(s&&p.x===s.x&&p.y===s.y)return 0;var d=f(p,t),h=f(p,n),y=f(g,t),m=f(g,n);return c&&y>d&&h>m?(s=p,o.dealy):(s=null,0)},c=function(e){a!==e&&(o.handler.enterHandler(e),a=e)},p=function(e,t){t?r.isDelay=!0:r.isDelay=!1;var n=f(t);n?i=setTimeout(function(){p(r.currentTarget,r.currentTarget)},n):(r.isDelay=!1,c(e))},g=function(e){l.push({x:e.pageX,y:e.pageY}),l.length>3&&l.shift()},d=function(){a=null,o.handler.leaveHandler()},h=function(){r.isDelay=!1,a=null,i&&clearTimeout(i)},y=function(e){if(r.currentTarget=e.currentTarget,!r.isDelay){i&&clearTimeout(i);var t=e.relatedTarget,n=u(t).parent(o.rows);p(e.currentTarget,n)}};r.$wrap.on("mousemove",g).on("mouseleave",d),r.$menu.on("mouseleave",h).delegate("mouseenter",o.rows,y)},l.prototype.init=function(){this.getOffset(),this.bindEvent()},r.exports=l});KISSY.add("tbc/search-suggest/6.1.3/tpl/cloud",[],function(a,t,l,s){s.exports={navi:function(a){var t='<div id="J_CloudList'+a.prefix+'" data-align="false" class="J_cloud-handle cloud-navi-list" '+a.autoAttr+'> <div class="inner-wrap"> <a class="cloud-img-wrap" href="//'+a.data.url+"?source=suggest&suggest=navi_"+a.index+'_1" target="_self"> <img src="//img.alicdn.com/tps/i1/'+a.data.logo+'_70x70.jpg" /> </a> <p>'+a.data.title+'</p> <a class="cloud-btn-wrap" href="//'+a.data.url+"?source=suggest&suggest=navi_"+a.index+'_1" target="_self"> <span class="cloud-link">'+a.data.button+"</span><i>></i> </a> </div></div>";return t},qrcode:function(a){var t='<div id="J_CloudList'+a.prefix+'" data-align="false" class="J_cloud-handle cloud-qrcode" '+a.autoAttr+' > <div class="inner-wrap"> <a href="'+a.data.url+'"><img src="'+a.data.image+'"/></a> </div></div>';return t},spu:function(a){var t='<div id="J_CloudList'+a.prefix+'" data-align="false" class="J_cloud-handle cloud-spu-list" '+a.autoAttr+' > <div class="inner-wrap"> <ul> ',l=a.data;if(l)for(var s,i=-1,e=l.length-1;e>i;)s=l[i+=1],t+=' <li> <a class="cloud-img-wrap cloud-link" href="//'+s.url+"&source=suggest&suggest=spu_"+a.index+"_"+(~~i+1)+'" target="_self"> <img src="//img.alicdn.com/tps/i1/'+s.pic+'_50x50.jpg" /> </a> <a class="cloud-title" title="'+s.title+'" href="//'+s.url+"&source=suggest&suggest=spu_"+a.index+"_"+(~~i+1)+'" target="_self"> <span>'+s.title+'</span> </a> <p class="cloud-price '+(0===~~s.price?"cloud-hidden":"")+'">参考价:<b class="">￥'+s.price+'</b><b class="noprice">暂无</b></p> </li> ';return t+=' </ul> <p class="cloud-total '+a.ishidden+'"> <span class="total">共'+a.count+'款产品</span> <a class="more" target="_self" href="//'+a.link+"&source=suggest&suggest=spu_"+a.index+'_more">查看全部>></a> </p> </div></div>'},tag:function(a){var t='<div id="J_CloudList'+a.prefix+'" data-align="true" class="J_cloud-handle cloud-list" '+a.autoAttr+' > <div class="inner-wrap"><h3>'+a.tagTitle+"</h3> <ul> ",l=a.data;if(l)for(var s,i=-1,e=l.length-1;e>i;)s=l[i+=1],t+=' <li><a target="_self" href="'+a.action+"?q="+a.tagTitle+" "+s+"&wq="+a.query+"&source=suggest&suggest=magic_"+a.index+"_"+(~~i+1)+"&tag="+s+a.param+'" class="cloud-link"><span>'+s+"</span></a></li> ";return t+=" </ul> </div></div>"},tag_group:function(a){var t='<div id="J_CloudList'+a.prefix+'" data-align="true" class="J_cloud-handle cloud-list type-taggroup" '+a.autoAttr+' > <div class="inner-wrap"><h3>'+a.tagTitle+"</h3> <ul> ",l=a.data;if(l)for(var s,i=-1,e=l.length-1;e>i;){s=l[i+=1],t+=' <li  class="tag-group"> <ul> ';var r=s;if(r)for(var d,u=-1,n=r.length-1;n>u;)d=r[u+=1],t+=' <li> <a target="_self" href="'+a.action+"?q="+encodeURIComponent(a.tagTitle+" "+d.title)+"&wq="+a.query+"&source=suggest&suggest=magic_"+a.index+"_"+(~~u+1)+"&tag="+d.title+a.param+'" class="cloud-link '+d.type+'"><span>'+d.title+"</span></a> </li> ";t+=" </ul> </li> "}return t+=" </ul> </div></div>"},topbrand:function(a){var t='<div id="J_CloudList'+a.prefix+'" data-align="false" class="J_cloud-handle cloud-topbrand-list" '+a.autoAttr+' > <div class="inner-wrap"> <h3>“'+a.tagTitle.substr(0,11)+"”热门品牌</h3><ul> ",l=a.data;if(l)for(var s,i=-1,e=l.length-1;e>i;)s=l[i+=1],t+=' <li> <a class="cloud-title cloud-link" href="//'+s.url+"&source=suggest&suggest=brandlist_"+a.index+"_"+(~~i+1)+'" target="_self"> <span><i class="cloud-top'+i+'">'+(~~i+1)+"</i>"+s.title+"</span> </a> </li> ";return t+=" </ul> </div></div>"}}});KISSY.add("tbc/search-suggest/6.1.3/mods/bts",["base","tbc/search-suggest/6.1.3/mods/utils"],function(t,e,s,u){function c(t){c.superclass.constructor.call(this,t||{})}var n=e("base"),r=e("tbc/search-suggest/6.1.3/mods/utils");KISSY.extend(c,n,{getBucket:function(){var t=this,e=t.getCookieT(),s=t.getTestBucket()||t.retBucket(e,20,-4,4)-0;return s},getTestBucket:function(){var t=location.search,e=t.match(/alg_bts=(\d+)/);return e&&e[1]?e[1]-0:void 0},getCookieT:function(){var t=new r,e=t.getCookie("t");return e},retBucket:function(t,e,s,u){return t?this.countBucket(t,e,s,u):"0"},countBucket:function(t,e,s,u){var c=t.substr(s,u),n=parseInt(c,16),r=n%e+1;return r+""}},{ATTRS:{pluginId:{value:"bts"}}}),u.exports=c});KISSY.add("tbc/search-suggest/6.1.3/mods/stat",["cookie","base","event","tbc/search-suggest/6.1.3/mods/local-query"],function(e,t,a,n){function s(e){s.superclass.constructor.call(this,e||{})}t("cookie");var i=t("base"),c=t("event"),r=t("tbc/search-suggest/6.1.3/mods/local-query");KISSY.extend(s,i,{pluginInitializer:function(e){var t=this,a=t.get("stat");t.set("caller",e),e.on("beforeSubmit",function(e){var a=e.isInitSearch;t.setStat(a)}),a&&(t.sendTongji(),t.bindSearchTrace())},bindSearchTrace:function(){var e=this;c.delegate("body","click","a",e.initSearchTrace,e)},initSearchTrace:function(e){var t=this,a=e.currentTarget,n=a.getAttribute("trace"),s=a.getAttribute("href");if(n)switch(n){case"relatedSearch":t.saveQuery();break;case"auction":var i=t.stat;i&&-1===s.indexOf("initiative_new")&&a.setAttribute("href",s+"&initiative_new=1")}},sendTongji:function(){var e,t=this,a=t.getStatInst();a.checkFlash({onSuccess:function(){e=a.query("stat")[0],e&&e.value&&(t.stat=e.value,t.send("f_stats_show="+e.value,!0))}})},setStat:function(e,t){var a=this,n=a.get("caller"),s=n.query,i=a.saveQuery(s,e);i&&a.send("lf_aclog=null-null-null-null-0&stats_click="+i,t)},getStatInst:function(){var e=this,t=e.get("caller"),a=t.get("sugConfig"),n=a.tab||"",s=new r({name:"stat",tab:n});return s},saveQuery:function(e,t){var a,n,s=this.getStatInst();return t&&e?(a=encodeURIComponent(e),n="initiative_new:1;q:"+a,s.save("stat",n)):s.deleteItem("stat"),n},send:function(e,t){var a,n,s=this.get("logTypes");t?(s=this.get("tongjiKey"),a=s.logkey,n=s.chksum):(s=this.get("pvKey"),a=s.logkey,n=s.chksum),window.goldlog?goldlog.record(a,"",e,n):(window.goldlog_queue||(window.goldlog_queue=[])).push({action:"goldlog.record",arguments:[a,"",e,n]})},renderPlugin:function(){}},{ATTRS:{pluginId:{value:"stat"},tongjiKey:{value:{logkey:"/tongji",chksum:"H51884970"}},pvKey:{value:{logkey:"/search",chksum:"H51884969"}}}}),n.exports=s});